# Автоматика для ректификации и дистилляции с модулем WiFi.

Устройство предназначено для автоматизации процессов дистилляции
и ректификации. 

Для дистанционного отслеживания и управлением
процессов используется модуль WiFi. Дистанционное управление
происходит по протоколу MQTT. Для пользованием этой функции на
мобильном устройстве или планшете должно быть установлено
соответствующее программное обеспечение – MQTT клиент. Ниже будет дан
пример настройки такого приложения.

Так же реализована возможность фракционного отбора, посредством
сервопривода. 

# Подключение автоматики к домашней сети WiFi. 

Прежде чем подключать и настраивать автоматику нужно создать
учетную запись на MQTT брокере.

Из бесплатных брокеров можно порекомендовать следующие:
1. http://mqtt.by/
2. http://www.dioty.co

Оба эти брокера работают с топиками созданными по следующей схеме:

1.mqtt.by
При регистрации будет запрос ввести логин.
ВНИМАНИЕ!!!
Принимаются только латиница и желательно что бы логин имел
небольшую длину!!!
После получения доступа к сайту будет выдан пароль для работы
клиента и показаны примеры создаваемых топиков:
Префикс топика: /user/ваш_логин_при_регистрации/
Другими словами для работы с автоматикой к каждому топику
(см.ниже) данных будет прибавляться эта строка. Например, для
топика температуры в кубе (топик term_d) топик примет вид -
/user/ВАШ_ЛОГИН_ПРИ_РЕГИСТРАЦИИ/term_d

2.dioty.co
На этом брокере для регистрации используется аккаунт гугл.
Если у вас нет этого аккаунта или его имя имеет большую длину
, то лучше завести новую учетную запись гугл.
Для этого брокера топики будут иметь вид (топик term_d):
/ВАШ_АККАУНТ@gmail.com/term_d

После этого можно подключать автоматику к домашней сети WiFi
и MQTT брокеру.

## Для подключения автоматики к сети WiFi нужно сделать следующее:

1. Подключить автоматику к питающей сети 220В (это можно
сделать без подключения датчиков температуры и клапанов).
ВНИМАНИЕ!!!! Недопустимо касание разъемов для
подключения клапанов , так как они могут находиться под
напряжением сети.
2. Включить автоматику тумблером на лицевой панели.
Дождаться появления надписей на дисплее и звукового
сигнала.
3. В это время автоматика сделает попытку подключиться к сети
WiFi с настройками полученными ранее. При неудачной
попытке делать это автоматика создаст точку доступа для
возможности коррекции введенных ранее данных. Внутри
можно увидеть как начнет постоянно светить синий
светодиод.
4. После этого нужно подключиться к автоматике как к точке
доступа , или с ноутбука или с мобильного телефона.
Выбираем сеть “ALCO_ESP”, пароль не требуется.
5. Затем запускаем браузер и в командной строке набираем адрес 192.168.4.1.
Жмем клавишу “Enter”.
Загрузится страница настроек, где мы и должны заполнить данными поля:
   1. Название домашней WiFi сети.
   2. Пароль от домашней сети.
   3. Название MQTT брокера.
   4. Имя пользователя.
   5. Пароль пользователя.
   6. Порт пользователя.
   7. Префикс для топиков. (вводить со всеми знаками / )

После чего нажимаем “Save settings”. Выведется окно с
сообщением об записи введенных параметров.

После этого автоматику можно отключить. При последующем
включении она будет автоматически подключаться к заданной
WiFi сети.

ВНИМАНИЕ!!! Будьте очень внимательны при вводе настроек,
если введены неправильные настройки MQTT сервера, а
настройки WiFi верны, то подключение к сети произойдет, но
без подключения к серверу MQTT. 
Если это произошло, то придется отключить домашний роутер ,
включить автоматику и дождаться когда она снова создаст точку
доступа и заново заполнить ВСЕ !!!! поля на странице настроек.


## Настройка приложения для Андроид.

Существует множество программ для работы с MQTT
протоколом в качестве клиента. Рассмотрим самую простую и
бесплатную программу.
Ссылка на MQTT клиента для Андроид :
https://play.google.com/store/apps/details?id=net.routix.mqttdash&hl
=ru
Инструкция по настройке в картинках :
http://whitefluffybear.blogspot.com/p/mqtt-dash.html

### Ниже приводятся название топиков для создания плиток в рабочем поле программы.

ВНИМАНИЕ!!!!!
Обязательно перед данными топиками, при использовании
вышеописанных брокеров, должны быть префиксы, которые
необходимы для работы клиентов и самого брокера.

#### ТОЛЬКО подписки:

term_d - температура в дефлегматоре

term_c - температура в царге

term_k - температура в кубе

power - измеренная мощность

press_a - атмосферное давление

flag_otb - режим работы

#### Подписки с ПУБЛИКАЦИЯМИ:
(первая строка подписка, вторая - публикация, обновление сделать не сразу, а через 3 сек)

term_d_m - аварийная температура в дефлегматоре

term_d_m_new - новая аварийная температура в дефлегматоре

press_c_m - аварийное давление в кубе

press_c_m_new - задание нового значения

term_c_max - температура старт-стопа

term_c_max_new - задание нового значения

term_c_min - температура возобновления отбора

term_c_min_new -задание нового значения

term_k_m - максимальная температура в кубе (END!)

term_k_m_new - новое значение максимальной температуры в кубе

term_nasos - температура в кубе включения клапана на воду

term_nasos_new - новое значение температуры включения клапана воды

power_m - стабилизируемая мощность

power_m_new - новое значение мощности

press_c_m - аварийное давление в кубе

press_c_m_new - новое значение

otbor - ШИМ отбора

otbor_new - новое значение

time_stop - максимальное время сработавшего старт-стопа

time_stop_new - новое значение

otbor_minus - декремент отбора тела

otbor_minus_new - новый декремент отбора тела

min_otb - период при отборе голов периодикой

min_otb_new - новый период при отборе голов периодикой

sek_otb - время открытого состояния клапана при отборе голов периодикой

sek_otb_new - новое время открытого состояния клапана при отборе голов периодикой

otbor_g_1 – ШИМ отбора для голов покапельно

otbor_g_1_new – новое значение ШИМ отбора

otbor_g_2 – ШИМ отбора для подголовников

otbor_g_2_new – новое значение

otbor_t – ШИМ отбора для тела

otbor_t_new – новое значение для отбора тела

delta_t – значение разницы температуры стабилизированной колонной и температурой старт-стопа

delta_t_new – новое значение данного параметра

term_k_r - температура в кубе для разгона

ВНИМАНИЕ!!! Для создания этой плитки в подписке указываем
term_k_m, а в публикации term_k_r


### Подписка с публикацией по одному имени!!! (work)
Добавляем как плитку "Мульти выбор", называем по русски,
указываем подписку work, галку в публикации оставляем без
указания имени публикации

Внизу можно добавлять значения 0,1,2,3 и т.д. Значениями 2 и 3
из списка БЕЗ КРАЙНЕЙ НЕОБХОДИМОСТИ не
пользоваться!!!!

work:
0. стоп
1. старт
2. рестарт
3. сброс отображения
4. разгон
5. выключение разгона
6. отбор выключен
7. отбор голов периодикой
8. отбор тела
9. отбор голов покапельно
10. отбор подголовников

Тип плитки для работы с контактором – «Выключатель».
/user/ВАШ_ЛОГИН/KONTAKTOR
Значение 1 – контактор включен
Значение 0 – контактор выключен

Ссылка на видео на пример настроенной программы :
https://youtu.be/cFHJj1ylkpk

**ВНИМАНИЕ!!!!!**
Обязательно перед данными топиками, при использовании
вышеописанных брокеров, должны быть префиксы, которые
необходимы для работы клиентов и самого брокера. В данном
видео показаны примеры ввода топиков БЕЗ необходимых
префиксов!!!